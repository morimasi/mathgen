 @tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    @apply bg-stone-100 text-stone-900 dark:bg-stone-900 dark:text-stone-100 transition-colors duration-300;
  }
  
  aside, main {
    background-color: rgb(var(--theme-block-bg-rgb));
    color: rgb(var(--theme-block-text-rgb));
    transition: background-color 0.3s, color 0.3s;
  }

  :root {
    --theme-color-black: #1c1917; /* stone-900 */
    --theme-color-blue: #1e3a8a;  /* blue-800 */
    --theme-color-sepia: #78350f; /* amber-800 */
  }

  /* --- THEME SYSTEM --- */
  :root, .theme-orange {
    --theme-color-primary-rgb: 234 88 12;
    --theme-color-primary-hover-rgb: 194 65 12;
    --theme-color-primary-focus-rgb: 249 115 22;
    --theme-accent-text: theme('colors.orange.700');
    --theme-accent-bg: theme('colors.orange.100');
    --theme-block-bg-rgb: 255 237 213;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-mint {
    --theme-color-primary-rgb: 5 150 105;
    --theme-color-primary-hover-rgb: 4 120 87;
    --theme-color-primary-focus-rgb: 16 185 129;
    --theme-accent-text: theme('colors.emerald.700');
    --theme-accent-bg: theme('colors.emerald.100');
    --theme-block-bg-rgb: 209 250 229;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-rose {
    --theme-color-primary-rgb: 225 29 72;
    --theme-color-primary-hover-rgb: 190 18 60;
    --theme-color-primary-focus-rgb: 244 63 94;
    --theme-accent-text: theme('colors.rose.700');
    --theme-accent-bg: theme('colors.rose.100');
    --theme-block-bg-rgb: 255 228 231;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-sky {
    --theme-color-primary-rgb: 2 132 199;
    --theme-color-primary-hover-rgb: 3 105 161;
    --theme-color-primary-focus-rgb: 14 165 233;
    --theme-accent-text: theme('colors.sky.700');
    --theme-accent-bg: theme('colors.sky.100');
    --theme-block-bg-rgb: 224 242 254;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-lavender {
    --theme-color-primary-rgb: 139 92 246;
    --theme-color-primary-hover-rgb: 124 58 237;
    --theme-color-primary-focus-rgb: 167 139 250;
    --theme-accent-text: theme('colors.violet.700');
    --theme-accent-bg: theme('colors.violet.100');
    --theme-block-bg-rgb: 237 233 254;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-graphite {
    --theme-color-primary-rgb: 51 65 85;
    --theme-color-primary-hover-rgb: 30 41 59;
    --theme-color-primary-focus-rgb: 71 85 105;
    --theme-accent-text: theme('colors.slate.700');
    --theme-accent-bg: theme('colors.slate.100');
    --theme-block-bg-rgb: 226 232 240;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-gold {
    --theme-color-primary-rgb: 251 191 36;
    --theme-color-primary-hover-rgb: 245 158 11;
    --theme-color-primary-focus-rgb: 252 211 77;
    --theme-accent-text: theme('colors.amber.700');
    --theme-accent-bg: theme('colors.amber.100');
    --theme-block-bg-rgb: 254 249 195;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-forest {
    --theme-color-primary-rgb: 21 128 61;
    --theme-color-primary-hover-rgb: 22 101 52;
    --theme-color-primary-focus-rgb: 22 163 74;
    --theme-accent-text: theme('colors.green.700');
    --theme-accent-bg: theme('colors.green.100');
    --theme-block-bg-rgb: 220 252 231;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-coral {
    --theme-color-primary-rgb: 248 113 113;
    --theme-color-primary-hover-rgb: 239 68 68;
    --theme-color-primary-focus-rgb: 252 165 165;
    --theme-accent-text: theme('colors.red.700');
    --theme-accent-bg: theme('colors.red.100');
    --theme-block-bg-rgb: 254 226 226;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-midnight {
    --theme-color-primary-rgb: 30 64 175;
    --theme-color-primary-hover-rgb: 30 58 138;
    --theme-color-primary-focus-rgb: 37 99 235;
    --theme-accent-text: theme('colors.blue.700');
    --theme-accent-bg: theme('colors.blue.100');
    --theme-block-bg-rgb: 219 234 254;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-ruby {
    --theme-color-primary-rgb: 190 18 60;
    --theme-color-primary-hover-rgb: 159 18 57;
    --theme-color-primary-focus-rgb: 225 29 72;
    --theme-accent-text: theme('colors.rose.700');
    --theme-accent-bg: theme('colors.rose.100');
    --theme-block-bg-rgb: 255 228 231;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-emerald {
    --theme-color-primary-rgb: 4 120 87;
    --theme-color-primary-hover-rgb: 5 102 73;
    --theme-color-primary-focus-rgb: 16 185 129;
    --theme-accent-text: theme('colors.emerald.700');
    --theme-accent-bg: theme('colors.emerald.100');
    --theme-block-bg-rgb: 209 250 229;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-amethyst {
    --theme-color-primary-rgb: 126 34 206;
    --theme-color-primary-hover-rgb: 107 33 168;
    --theme-color-primary-focus-rgb: 147 51 234;
    --theme-accent-text: theme('colors.purple.700');
    --theme-accent-bg: theme('colors.purple.100');
    --theme-block-bg-rgb: 243 232 255;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-latte {
    --theme-color-primary-rgb: 199 161 122;
    --theme-color-primary-hover-rgb: 180 140 100;
    --theme-color-primary-focus-rgb: 218 182 144;
    --theme-accent-text: #8D6947;
    --theme-accent-bg: #F5EFE6;
    --theme-block-bg-rgb: 240 230 220;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-mocha {
    --theme-color-primary-rgb: 141 105 71;
    --theme-color-primary-hover-rgb: 120 89 60;
    --theme-color-primary-focus-rgb: 161 120 81;
    --theme-accent-text: #704825;
    --theme-accent-bg: #E4D5C6;
    --theme-block-bg-rgb: 210 180 140;
    --theme-block-text-rgb: 15 23 42;
  }
  .theme-espresso {
    --theme-color-primary-rgb: 78 54 33;
    --theme-color-primary-hover-rgb: 60 42 25;
    --theme-color-primary-focus-rgb: 97 67 41;
    --theme-accent-text: #4E3621;
    --theme-accent-bg: #D4C8BC;
    --theme-block-bg-rgb: 188 158 130;
    --theme-block-text-rgb: 15 23 42;
  }

  /* Dark Mode Overrides */
  .dark {
    --theme-color-black: #f5f5f4; /* stone-100 */
    --theme-color-blue: #93c5fd;  /* blue-300 */
    --theme-color-sepia: #fcd34d; /* amber-300 */
  }
  .dark.theme-orange {
    --theme-accent-text: theme('colors.orange.400');
    --theme-accent-bg: theme('colors.orange.900/50');
    --theme-block-bg-rgb: 41 23 1;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-mint {
    --theme-accent-text: theme('colors.emerald.400');
    --theme-accent-bg: theme('colors.emerald.900/50');
    --theme-block-bg-rgb: 6 54 41;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-rose {
    --theme-accent-text: theme('colors.rose.400');
    --theme-accent-bg: theme('colors.rose.900/50');
    --theme-block-bg-rgb: 76 5 25;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-sky {
    --theme-accent-text: theme('colors.sky.400');
    --theme-accent-bg: theme('colors.sky.900/50');
    --theme-block-bg-rgb: 8 48 77;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-lavender {
    --theme-accent-text: theme('colors.violet.400');
    --theme-accent-bg: theme('colors.violet.900/50');
    --theme-block-bg-rgb: 36 17 75;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-graphite {
    --theme-color-primary-rgb: 100 116 139;
    --theme-color-primary-hover-rgb: 71 85 105;
    --theme-color-primary-focus-rgb: 148 163 184;
    --theme-accent-text: theme('colors.slate.400');
    --theme-accent-bg: theme('colors.slate.800/50');
    --theme-block-bg-rgb: 30 41 59;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-gold {
     --theme-accent-text: theme('colors.amber.400');
    --theme-accent-bg: theme('colors.amber.900/50');
    --theme-block-bg-rgb: 71 55 8;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-forest {
    --theme-accent-text: theme('colors.green.400');
    --theme-accent-bg: theme('colors.green.900/50');
    --theme-block-bg-rgb: 15 63 31;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-coral {
     --theme-accent-text: theme('colors.red.400');
    --theme-accent-bg: theme('colors.red.900/50');
    --theme-block-bg-rgb: 78 14 14;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-midnight {
    --theme-color-primary-rgb: 96 165 250;
    --theme-color-primary-hover-rgb: 59 130 246;
    --theme-color-primary-focus-rgb: 147 197 253;
    --theme-accent-text: theme('colors.blue.400');
    --theme-accent-bg: theme('colors.blue.900/50');
    --theme-block-bg-rgb: 30 58 138;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-ruby {
    --theme-color-primary-rgb: 244 63 94;
    --theme-color-primary-hover-rgb: 225 29 72;
    --theme-color-primary-focus-rgb: 251 113 133;
    --theme-accent-text: theme('colors.rose.400');
    --theme-accent-bg: theme('colors.rose.900/50');
    --theme-block-bg-rgb: 134 25 54;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-emerald {
    --theme-color-primary-rgb: 52 211 153;
    --theme-color-primary-hover-rgb: 16 185 129;
    --theme-color-primary-focus-rgb: 110 231 183;
    --theme-accent-text: theme('colors.emerald.400');
    --theme-accent-bg: theme('colors.emerald.900/50');
    --theme-block-bg-rgb: 4 78 55;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-amethyst {
    --theme-color-primary-rgb: 168 85 247;
    --theme-color-primary-hover-rgb: 147 51 234;
    --theme-color-primary-focus-rgb: 192 132 252;
    --theme-accent-text: theme('colors.purple.400');
    --theme-accent-bg: theme('colors.purple.900/50');
    --theme-block-bg-rgb: 88 28 135;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-latte {
    --theme-color-primary-rgb: 199 161 122;
    --theme-color-primary-hover-rgb: 218 182 144;
    --theme-color-primary-focus-rgb: 180 140 100;
    --theme-accent-text: #E6D5C3;
    --theme-accent-bg: #4A3A29;
    --theme-block-bg-rgb: 94 73 52;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-mocha {
    --theme-color-primary-rgb: 141 105 71;
    --theme-color-primary-hover-rgb: 161 120 81;
    --theme-color-primary-focus-rgb: 120 89 60;
    --theme-accent-text: #BFA58C;
    --theme-accent-bg: #3E2914;
    --theme-block-bg-rgb: 69 46 20;
    --theme-block-text-rgb: 229 231 235;
  }
  .dark.theme-espresso {
    --theme-color-primary-rgb: 78 54 33;
    --theme-color-primary-hover-rgb: 97 67 41;
    --theme-color-primary-focus-rgb: 60 42 25;
    --theme-accent-text: #A8917D;
    --theme-accent-bg: #291C0F;
    --theme-block-bg-rgb: 46 31 17;
    --theme-block-text-rgb: 229 231 235;
  }

  /* Font Themes */
  .font-theme-klasik { --font-worksheet: 'Lora', serif; }
  .font-theme-modern { --font-worksheet: 'Nunito Sans', sans-serif; }
  .font-theme-disleksi1 { --font-worksheet: 'Lexend', sans-serif; }
  .font-theme-disleksi2 { --font-worksheet: 'Atkinson Hyperlegible', sans-serif; }
  .font-theme-eglenceli { --font-worksheet: 'Caveat', cursive; }
  .font-theme-yumusak { --font-worksheet: 'Comfortaa', sans-serif; }
  .font-theme-blok { --font-worksheet: 'Roboto Slab', serif; }
  .font-theme-net { --font-worksheet: 'Montserrat', sans-serif; }

  #worksheet-area {
    font-family: var(--font-worksheet);
  }

  .accent-primary-color {
      accent-color: rgb(var(--theme-color-primary-rgb));
  }
}

@layer components {
  .worksheet-area {
    @apply flex flex-col items-center;
    transform: scale(var(--scale, 1));
    transform-origin: top center;
    transition: transform 0.2s ease;
  }
  .worksheet-page {
    @apply shadow-lg my-4 relative;
    background-color: rgb(var(--theme-block-bg-rgb));
    width: 210mm;
    min-height: 297mm;
    box-sizing: border-box;
    font-size: var(--font-size);
    line-height: var(--line-height);
    text-align: var(--text-align);
    color: var(--color);
  }
  .worksheet-page.landscape {
      width: 297mm;
      min-height: 210mm;
  }
  .worksheet-header { @apply flex justify-between text-sm mb-8 pb-2 border-b-2 border-current; }
  .header-field { @apply border-b border-dotted border-current flex-1 min-w-[150px]; }
  .header-field:not(:last-child) { @apply mr-8; }
  .worksheet-title { @apply text-2xl font-bold mb-4; }
  .worksheet-preamble { @apply text-base mb-6 italic; }
  .worksheet-body.layout-flow {
    @apply grid;
    grid-template-columns: repeat(var(--columns, 2), 1fr);
    gap: var(--problem-spacing) var(--column-gap);
  }
  .worksheet-body.layout-table {
    @apply grid border border-current;
    grid-template-columns: repeat(var(--columns, 2), 1fr);
    grid-template-rows: repeat(var(--rows, 10), auto);
  }
  .worksheet-body.layout-table .problem-item { @apply border-b border-r border-current p-4 m-0; }
  .problem-item { @apply flex items-start gap-2 break-inside-avoid; margin-bottom: var(--problem-spacing); }
  .problem-item.flow { @apply flex-col items-center; }
  .problem-item.layout-with-visual-space { @apply flex-col items-stretch; }
  .visual-space { @apply w-full h-48 border-2 border-dashed border-stone-300 rounded-md mt-2; }
  .problem-item.layout-given-wanted { @apply flex-col items-stretch; }
  .given-wanted-container { @apply mt-2 space-y-2 text-sm; }
  .solution-box { @apply w-full h-12 border border-stone-300 rounded p-1 mt-1; }
  .solution-box.tall { @apply h-24; }
  .answer-key { @apply bg-white p-8 hidden w-[210mm] box-border; }
  @keyframes daisy-sway { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(5deg); } }
  .daisy-sway { animation: daisy-sway 4s ease-in-out infinite; transform-origin: 75px 140px; }
  @keyframes crawl { 0% { transform: translate(0, 0) rotate(-10deg); } 25% { transform: translate(5px, -10px) rotate(0deg); } 50% { transform: translate(-5px, -20px) rotate(10deg); } 75% { transform: translate(0, -30px) rotate(0deg); } 100% { transform: translate(0, 0) rotate(-10deg); } }
  .crawling-bug { animation: crawl 8s ease-in-out infinite; }
  .flying-ladybug-container { position: absolute; width: 40px; height: 40px; will-change: transform, opacity, top, left; }
  .wings { transform-origin: 30px 30px; animation: flap 0.1s linear infinite alternate; }
  .left-wing { transform-origin: 30px 30px; animation: flap-left 0.1s linear infinite alternate; }
  .right-wing { transform-origin: 30px 30px; animation: flap-right 0.1s linear infinite alternate; }
  @keyframes flap-left { from { transform: rotate(-5deg); } to { transform: rotate(25deg); } }
  @keyframes flap-right { from { transform: rotate(5deg); } to { transform: rotate(-25deg); } }
  .toast-container { @apply fixed bottom-4 right-4 z-50 flex flex-col items-end gap-3; }
  .toast-item { @apply flex items-center gap-3 p-3 rounded-lg shadow-lg border w-80; }
  .toast-item-enter { animation: toast-enter 0.3s ease-out forwards; }
  .toast-item-exit { animation: toast-exit 0.3s ease-in forwards; }
  @keyframes toast-enter { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
  @keyframes toast-exit { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }
  .table-selector-grid { @apply grid gap-1 p-1 bg-stone-100 dark:bg-stone-700 border border-stone-200 dark:border-stone-600 rounded; grid-template-columns: repeat(10, 1fr); }
  .table-selector-cell { @apply w-5 h-3 bg-stone-300 dark:bg-stone-500 rounded-sm transition-colors cursor-pointer; }
  .table-selector-cell.selected { @apply bg-primary; }
  .live-indicator { @apply text-xs font-bold px-2 py-0.5 rounded-full bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300 animate-pulse; }

  /* Constellation Header */
  .constellation-header {
    height: 160px;
    position: relative;
    overflow: hidden;
    background: linear-gradient(to bottom, #4a2511, #1c0d06);
  }
  
  @keyframes move-stars-1 { from { background-position: 0 0; } to { background-position: -10000px 5000px; } }
  @keyframes move-stars-2 { from { background-position: 0 0; } to { background-position: -8000px 4000px; } }
  @keyframes move-stars-3 { from { background-position: 0 0; } to { background-position: -6000px 3000px; } }
  
  .stars, .stars2, .stars3 {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    display: block;
    background: transparent url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.3)"/></svg>') repeat;
    background-size: 1000px 1000px;
    animation: move-stars-1 200s linear infinite;
  }
  .stars2 {
     background-size: 800px 800px;
     animation: move-stars-2 150s linear infinite;
     background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="20" cy="80" r="0.8" fill="rgba(255,255,255,0.2)"/></svg>');
  }
  .stars3 {
     background-size: 600px 600px;
     animation: move-stars-3 100s linear infinite;
     background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.15)"/></svg>');
  }

  .constellation-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 5;
  }
  .constellation-lines {
    fill: none;
    stroke: rgba(255, 255, 255, 0.15);
    stroke-width: 0.8;
  }
  .star {
    fill: white;
    animation: twinkle 4s ease-in-out infinite;
  }

  @keyframes twinkle {
    0%, 100% {
      opacity: 0.7;
      transform: scale(0.9);
      filter: drop-shadow(0 0 2px #fff);
    }
    50% {
      opacity: 1;
      transform: scale(1.1);
      filter: drop-shadow(0 0 8px #fff) drop-shadow(0 0 15px #fef08a);
    }
  }
}

@media print {
  body {
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
    background-color: #fff !important;
  }
  
  aside, main {
    background-color: #fff !important;
    color: #000 !important;
  }

  /* Reset layout for printing, hide all UI except the worksheet area */
  body, #root, #root > div, #root > div > div.flex {
    display: block !important;
    height: auto !important;
    overflow: visible !important;
  }
  
  main, main > div {
    overflow: visible !important;
    height: auto !important;
    padding: 0 !important;
  }
  
  .worksheet-area {
    transform: none !important;
    padding: 0;
    margin: 0;
  }
  
  .worksheet-page {
    box-shadow: none !important;
    margin: 0 !important;
    border: none !important;
    width: 100% !important;
    min-height: 0 !important;
    height: auto;
    page-break-after: always;
    color: var(--color);
    background-color: #fff !important;
  }
  
  .worksheet-page.white-page {
      color: black;
  }

  @page {
    /* color is now applied directly to .worksheet-page for better control */
  }

  /* Ensure print-hidden utility works */
  .print-hidden, .print\:hidden {
    display: none !important;
  }
  .print-only {
    display: block !important;
  }
}

/* Fallback for JSDOM or other environments where 'rem' might not be defined */
:root {
  font-size: 16px;
}